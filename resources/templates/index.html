<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Paciente - Sistema SUS</title>
    <link rel="stylesheet" href="/css/global.css">
</head>
<body>
    <div class="navbar">
        <a href="/">Cadastrar Paciente</a>
        <a href="/pacientes/lista">Listar Pacientes</a>
        <a href="/chamados/cadastro">Registrar Chamado</a>
        <a href="/chamados/lista">Listar Chamados</a>
    </div>

    <div class="container">
        <h2>Cadastro de Paciente</h2>

        <form id="pacienteForm">

            <h3 class="section-title">Dados Pessoais</h3>
            <div class="form-group">
                <div>
                    <label for="nome">Nome Completo:</label>
                    <input type="text" id="nome" name="nome" required />
                </div>
                <div>
                    <label for="cpf">CPF:</label>
                    <input type="text" id="cpf" name="cpf" required placeholder="000.000.000-00" />
                </div>
            </div>
            <div class="form-group">
                <div>
                    <label for="dataDeNascimento">Data de Nascimento:</label>
                    <input type="date" id="dataDeNascimento" name="dataDeNascimento" required />
                </div>
                <div>
                    <label for="telefoneContato">Telefone:</label>
                    <input type="tel" id="telefoneContato" name="telefoneContato" required placeholder="(00) 00000-0000" />
                </div>
            </div>
            <div class="form-group full-width">
                 <label for="emailContato">Email:</label>
                 <input type="email" id="emailContato" name="emailContato" required placeholder="seuemail@exemplo.com"/>
            </div>

            <h3 class="section-title">Endereço</h3>
            <div class="form-group full-width">
                <label for="logradouro">Rua (Logradouro):</label>
                <input type="text" id="logradouro" name="endereco.logradouro" required />
            </div>
             <div class="form-group">
                <div>
                    <label for="numero">Número:</label>
                    <input type="text" id="numero" name="endereco.numero" required />
                </div>
                <div>
                     <label for="complemento">Complemento:</label>
                     <input type="text" id="complemento" name="endereco.complemento" />
                </div>
            </div>
            <div class="form-group">
                <div>
                    <label for="bairro">Bairro:</label>
                    <input type="text" id="bairro" name="endereco.bairro" required />
                </div>
                <div>
                    <label for="cidade">Cidade:</label>
                    <input type="text" id="cidade" name="endereco.cidade" required />
                </div>
            </div>
             <div class="form-group">
                <div>
                    <label for="estado">Estado (UF):</label>
                    <input type="text" id="estado" name="endereco.estado" required maxlength="2" pattern="[A-Za-z]{2}" placeholder="SP" />
                </div>
                <div>
                    <label for="cep">CEP:</label>
                    <input type="text" id="cep" name="endereco.cep" required pattern="\d{5}-\d{3}" placeholder="00000-000" />
                </div>
            </div>
            <div class="form-group full-width">
                <label for="pais">País:</label>
                <input type="text" id="pais" name="endereco.pais" value="Brasil" required />
            </div>


            <h3 class="section-title">Informações de Deficiência</h3>
            <div class="form-group checkbox-group full-width">
                <label for="possuiDeficiencia">Possui deficiência?</label>
                <input type="checkbox" id="possuiDeficiencia" name="possuiDeficiencia" />
            </div>

            <div id="deficienciaFields" style="display: none;">
                 <div class="form-group">
                    <div>
                        <label for="tipoDeficiencia">Tipo de deficiência:</label>
                        <select id="tipoDeficiencia" name="tipoDeficiencia">
                            <option value="">Selecione...</option>
                            <option value="FISICA">Física</option> <option value="AUDITIVA">Auditiva</option>
                            <option value="VISUAL">Visual</option>
                            <option value="MENTAL">Mental</option>
                            <option value="MULTIPLA">Múltipla</option>
                        </select>
                    </div>
                     <div>
                        <label for="observacoesDeficiencia">Observações:</label>
                        <input type="text" id="observacoesDeficiencia" name="observacoesDeficiencia" />
                    </div>
                </div>
            </div>

            <p id="mensagem" style="text-align: center; margin-top: 15px; font-weight: bold;"></p>

            <button type="submit">Salvar Paciente</button>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const possuiDeficienciaCheckbox = document.getElementById('possuiDeficiencia');
            const deficienciaFieldsDiv = document.getElementById('deficienciaFields');
            const tipoDeficienciaSelect = document.getElementById('tipoDeficiencia');
            const pacienteForm = document.getElementById('pacienteForm');
            const cepInput = document.getElementById('cep'); 
            const mensagemP = document.getElementById('mensagem');

            possuiDeficienciaCheckbox.addEventListener('change', function () {
                deficienciaFieldsDiv.style.display = this.checked ? 'block' : 'none';
            });

            cepInput.addEventListener('input', function (e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 5) {
                    value = value.replace(/^(\d{5})(\d{3})$/, '$1-$2');
                }
                e.target.value = value;
            });

            pacienteForm.addEventListener('submit', async function (e) {
                e.preventDefault();
                mensagemP.textContent = ''; 

                const possuiDeficiencia = possuiDeficienciaCheckbox.checked;

                if (possuiDeficiencia && !tipoDeficienciaSelect.value) {
                    mensagemP.textContent = "Erro: Selecione o tipo de deficiência.";
                    mensagemP.style.color = 'red';
                    return;
                }

                const endereco = {};
                const enderecoInputs = pacienteForm.querySelectorAll('input[name^="endereco."], select[name^="endereco."]');
                enderecoInputs.forEach(input => {
                    const key = input.name.substring('endereco.'.length);
                    endereco[key] = input.value;
                });

                const paciente = {
                    nome: document.getElementById('nome').value,
                    cpf: document.getElementById('cpf').value,
                    dataDeNascimento: document.getElementById('dataDeNascimento').value,
                    telefoneContato: document.getElementById('telefoneContato').value,
                    emailContato: document.getElementById('emailContato').value,
                    endereco: endereco,
                    possuiDeficiencia: possuiDeficiencia
                };

                if (possuiDeficiencia) {
                    paciente.tipoDeDeficiencia = tipoDeficienciaSelect.value;
                    paciente.observacoesDeficiencia = document.getElementById('observacoesDeficiencia').value;
                } else {
                    paciente.tipoDeDeficiencia = null; 
                    paciente.observacoesDeficiencia = null;
                }

                console.log("Enviando paciente:", JSON.stringify(paciente, null, 2)); 

                try {
                    const resposta = await fetch("/pacientes", { 
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(paciente)
                    });

                    if (resposta.ok) {
                        mensagemP.textContent = "Paciente salvo com sucesso!";
                        mensagemP.style.color = 'green';
                        pacienteForm.reset();
                        deficienciaFieldsDiv.style.display = "none";
                    } else {
                        const erro = await resposta.json(); 
                        console.error("Erro do servidor:", erro);
                        mensagemP.textContent = `Erro ao salvar: ${erro.message || 'Verifique os dados e o console.'}`;
                        mensagemP.style.color = 'red';
                    }
                } catch (error) {
                    console.error("Erro na requisição:", error);
                    mensagemP.textContent = `Erro de conexão: ${error.message}`;
                    mensagemP.style.color = 'red';
                }
            });
        });

        
    </script>
</body>
</html>